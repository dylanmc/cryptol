module Salsa20Test where

import Salsa20

// The following tests the specification against test vectors from 
// http://www.ecrypt.eu.org/stream/svn/viewcvs.cgi/ecrypt/trunk/submissions/salsa20/full/verified.test-vectors?logsort=rev&rev=210&view=markup

Set1Keys =
   [ 0x80000000000000000000000000000000
   , 0x00400000000000000000000000000000
   , 0x00002000000000000000000000000000
   , 0x00000010000000000000000000000000
   , 0x00000000080000000000000000000000
   , 0x00000000000400000000000000000000
   , 0x00000000000002000000000000000000
   , 0x00000000000000010000000000000000
   , 0x00000000000000000080000000000000
   , 0x00000000000000000000400000000000
   , 0x00000000000000000000002000000000
   , 0x00000000000000000000000010000000
   , 0x00000000000000000000000000080000
   , 0x00000000000000000000000000000400
   , 0x00000000000000000000000000000002]

s1keys =     [ groupBy`{8} k | k <- Set1Keys ]
nonces =   [ groupBy`{8}0x0000000000000000 | i <- [0 .. 255] ]
messages = [ zero:[512][8] | i <- [0 .. 255] ]

extractEcryptVectors s =
    [ s@@[0..63]
    , s@@[192..255]
    , s@@[256..319]
    , s@@[448..511] ]

// you can compare these to the stream [0..63] vectors
set1eCrypt : [15][4][64][8]
set1eCrypt = [ extractEcryptVectors (Salsa20_encrypt (k, iv, m))
        | k <- s1keys
        | iv <- nonces
        | m <- messages
        ]

set1raw = [ groupBy`{64} (Salsa20_encrypt (k, iv, m))
        | k <- s1keys
        | iv <- nonces
        | m <- messages
        ]


xorVector : {a} (fin a) => [a][64][8] -> [64][8]
xorVector chunks = xors ! 0 where
    xors = [zero:[64][8]] # [ prev ^ chunk | prev <- xors | chunk <- chunks ]

// the real test is to compare these against each vector's xor-digest:
xorVectors sets = [ xorVector set | set <- sets ]

// (stream is generated by encrypting 512 zero bytes)

set1xorDigests = [
       0xF7A274D268316790A67EC058F45C0F2A067A99FCDE6236C0CEF8E056349FE54C5F13AC74D2539570FD34FEAB06C572053949B59585742181A5A760223AFA22D4
    ,  0xB76A7991D5EE58FC51B9035E077E1315D81F131FA1F26CF22005C6C4F2412243C401A850AFEFAADC5B052435B51177C70AE68CB9DF9B44681C2D8B7049D89333
    ,  0xB9D233247408CD459A027430A23E6FCF3E9A3BAF0D0FC59E623F04D9C107D402880620C64A111318ECE60C22737BECA421F7D3D004E7191ECE2C7075289B31BF
    ,  0x0423874278AE11EF0A29B3E6E1A5BA41E43671636615E3F1F6215750E5A1749ACDFE0CEB74A11AC4862527C5849110C9A7A6F01E419372824BCAB90550340E81
    ,  0x19B8E721CD10577375FC6D0E6DC39B054E371860CE2AA310906EA7BAB28D737F2357B42E7DC1C48D597EA58B87602CE5C37EEDED2E0F4819938878AE7C50E151
    ,  0x4134A74A52EA89BF22E05A467E37E08215537896BE4D2BBDF29EA52A2303E64BD954A18928543C82B68A21E4B830A775CBA9D1176EBF8DB92938DF6E59117B74
    ,  0xE9CFBD15B5F4AD02903851F46728F2DD5910273E7360F1571EF1442199143B6C28E5368A2E00E08ADAE73AF3489E0D6F0D8032984ADD139B6BF508A5EEE4434B
    ,  0xFF021AEC5DC82F40BBF44CEA85287BCFD70F16F557F07B1BF970407051F71C415B703A67CAF8E81CB22D9F09E0CBD2475E9859355A48FDA9F48E38E2748BE41B
    ,  0xB2F239692CE50EECABD7A846AC33388543CFC1061F33420B6F205809F3965D899C56C02D208DD3E9A1F0D5BBED8F5DACB164FD005DF907002302F40ADB6665CC
    ,  0xB72D2FEE4BFBC0F65005EE2797B0608A7A6D9CD1114B67C0ADEC7B4B6D793182880777B0279E3DF27CBA820714629A96034E4C71F5356254A0116CF3E9F7EF5C
    ,  0x8866D8F9E6F423A7DF10C77625014AA582C06CD861A88F40FB9CD1EBF09111884344BEEA5A724E6FD8DB98BF4E6B9BEA5318FA62813D1B49A2D529FC00CB5777
    ,  0xF8AE82F9B77EF090AE0C72A5EAE2140568BEF0B354BCDF4BD39732CD86C63A82AFD27F58C459272B3E8A4B9B558D856F8475CF3A1AD99074822A836CFE520DC5
    ,  0x4DC82B00DC54141CC890348496115C681DB10ABE8454FBD10B49EF951CD20C6F7FE8AAA10906E57CF05EE838F76C8B7A3F9E6BD6D21C49F1590C913026C71A3E
    ,  0x65D58F845F973928ADF5803799901856A08952CF215154C52A5FF2DAD71E8B703DE107E5531491666353F323E790EB021B5EF66C13F43401F4F6A27F08CE11D5
    ,  0x2D72232A4485E0D2EEDC0619396020774C100C5424FF742B2868E3A68E67E1654C4711C54A34DA937359A26B8386AD2039EB2021DCFBB6A11603AF56225DE098 ]

property set1_passes_tests = xorVectors set1raw == [groupBy`{8} digest | digest <- set1xorDigests]

Set2Keys =
    [ 0x00000000000000000000000000000000
    , 0x09090909090909090909090909090909
    , 0x12121212121212121212121212121212
    , 0x1B1B1B1B1B1B1B1B1B1B1B1B1B1B1B1B
    , 0x24242424242424242424242424242424
    , 0x2D2D2D2D2D2D2D2D2D2D2D2D2D2D2D2D
    , 0x36363636363636363636363636363636
    , 0x3F3F3F3F3F3F3F3F3F3F3F3F3F3F3F3F
    , 0x48484848484848484848484848484848
    , 0x51515151515151515151515151515151
    , 0x5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A5A
    , 0x63636363636363636363636363636363
    , 0x6C6C6C6C6C6C6C6C6C6C6C6C6C6C6C6C
    , 0x75757575757575757575757575757575
    , 0x7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E
    , 0x87878787878787878787878787878787
    , 0x90909090909090909090909090909090
    , 0x99999999999999999999999999999999
    , 0xA2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2
    , 0xABABABABABABABABABABABABABABABAB
    , 0xB4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4
    , 0xBDBDBDBDBDBDBDBDBDBDBDBDBDBDBDBD
    , 0xC6C6C6C6C6C6C6C6C6C6C6C6C6C6C6C6
    , 0xCFCFCFCFCFCFCFCFCFCFCFCFCFCFCFCF
    , 0xD8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8
    , 0xE1E1E1E1E1E1E1E1E1E1E1E1E1E1E1E1
    , 0xEAEAEAEAEAEAEAEAEAEAEAEAEAEAEAEA
    , 0xF3F3F3F3F3F3F3F3F3F3F3F3F3F3F3F3
    , 0xFCFCFCFCFCFCFCFCFCFCFCFCFCFCFCFC ]

s2keys = [ groupBy`{8} key | key <- Set2Keys]

set2raw = [ groupBy`{64} (Salsa20_encrypt (k, iv, m))
        | k <- s2keys
        | iv <- nonces
        | m <- messages
        ]

set2xorDigests =
  [ 0x6D3937FFA13637648E477623277644ADAD3854E6B2B3E4D68155356F68B30490842B2AEA2E32239BE84E613C6CE1B9BD026094962CB1A6757AF5A13DDAF8252C
  , 0x30209DD68D46E5A30034EF6DCE74FE1AB6C772AB22CD3D6C354A9C4607EF3F82900423D29FB65E07FFA3AEAD94E940D6E52E305A10D60936D34BD03B3F342AB1
  , 0xAD29013FD0A222EEBE65126380A26477BD86751B3B0A2B4922602E63E6ECDA523BA789633BEE6CFF64436A8644CCD7E8F81B062187A9595A8D2507ED774FA5CD
  , 0x484F9FCB516547DD89AF46991B18F1DEC4C6CBC7D52735E00FC3201B4650151C3D4FB9C119442B368B28E3C68ED83F10D9DA2FDED7DEB8F04827FA91CCDBF65B
  , 0xD1781DCE3EFB8B13740F016264051354F323C81A13D42CE75E67180849AC49FFA7EA95720696F86848A1A4B8506A95E3A61371DDE7F21167CC147173BFC4D78F
  , 0x1F64F78101768FF5067B9A918444EF703FF06561E23B31C61BD43BCF86CFAD249942F73DC8F40AE49B14874B08F2A527A53DF496F37D067F1168268D4A134740
  , 0x0073DA29855E96EA5C414B9BD2E1C0F4987D3F1EB1CA73C4AA10180B99A437744857EB36586593B81088AADE5D89BBC68FBD8B0D268080746D6BE38DBC9396CD
  , 0x542B2672401C5D1225CC704365753E33D0827A863C4897FFCE1B724CD10B2A0E8A4E4CDAB7357424FC6DC78440037240B8FD5299907A946CE77DAFA5322AB73D
  , 0xC3E5CC5C7CEA1B3885EB9CEF2D1FAF18E7DE1CFD7237F2D6D344F3DF7168A88EC88C1314CB6F5A3EAE1BC468B4FAD75E8A42BE8607705C9A7950302461AD9B3F
  , 0x88A96FF895BF2A827FC26DB2BB75DC698E8E1B7E231997AB2942E981EF1633EA061F6B323B99519828FB41A6F5CCC79C57F6DDDD34DEAB38514A54C4886626E5
  , 0x554F89BF1AD5602655B800DB9B3CCFFA1B267D57654DCF3FDDA81A59DF68B022555E63DE51E7A83668E7F1AE09EEB5B8748DEF8580B304199C4D117CF9A94E78
  , 0x52D590BB5E396FCC2E00D9C51B3C0BF073E123C7EE69B528B0F0F87B57DC6907F4B57FD5F5B10D602B1F723E9FDD5510AEC60CD0DD50ED4B60FA355859638C2C
  , 0xFB3FE601D4E58B0766F02FA15C3323913CD745E905AD74EA5DABA77BC25D282DD66D98204E101F06D60BA446A21331AF6DDEB70679DEF46B886EB8A75C916380
  , 0xBB5EAC1AB84C70857245294309C023C4B1A4199D16877BC847BCBB1B0A8D1B544289D6C8BF27212AAFFD42021669BB2477A4F815FA01B3F7E88299240155265B
  , 0x0F1A4B0994EE03B6C381FE4BB8E33C0EE47C395BB59922C5537EEBFD125494220F743B93D867085E027E56623F79505608179A39FF52D4C00A45A5FB8F618C49
  , 0xB7F32B6FADB48BB8DA231BDBDC4697232BAE5F8F8345F9F14A991FF851CC3C641DF4913A5C550FC898F95AC299ED89155A434DC4B1E37D82EA137BB763F68BC7
  , 0xE30E770C75C94EE022BEA6B95241E5D7163D7C55AAF20FE7150768CEE6E1103742902FA4F928CDCF31335944DCDEBADDE36FE089D2EB93677E9DF75234E1B3C8
  , 0x8C9995B52F4AC9CA25E5C956850FFE90D396530617298D89659C2F863995FB060B65ADFED6AA977EDBB4FC2F6774335E9DEBC61E05E92718A340F79368E74273
  , 0xB2217FF55077D373B735C1A7D8B784F5187AF2F028FE906F85B938277CAC918CE87BEA508AFF86B9071F2B7E4F88A3B1F3323151C9DF441FE6F266CF8F01A0B9
  , 0x4EB0E761F6BD6A738DC295C0B1B737FCFDB2A68FF50EB198D699CC71141EC6EB54434D40B592A65F2F5C50B6027D4F529307969E1D74028FF4BD6A44CEAA121C
  , 0x88BE85838404EA4F0FFDD192C43E3B93329C4A4919234D116E4393EA26110022BED2B427EC719178E6F1A9B9B08BEF5BF2FE4A9CC869CB6BD2D989F750EDA78F
  , 0xDA74A6EC8D54723B1797751F786CB1B517995EBF297A034AF744EEF86833CC5BA3DCBDB4D3FAB47F5BA37463CEC80F45DAE1A48FBB80148A39CA789BAE09D39F
  , 0x54E422EB1EB2DBDB338798E0D352A87AD5F5A28BC5F77E1B42913E6500723A936D4019D703DC93A1DF7C65AB74F1FC1A4D38C519A8338B73A435FC7491DFC769
  , 0xBB97F09B9FCEC06B6124310BBDD1E9CE8D3793F62FF1337F520DE2A90FE2592AF2636DFA20466FDAA9329443ACC0E9A50492621AF5790CAE5642E6F7D9AF400D
  , 0x8A365EE7E7BC9198EC88A39F5047431D1632CBB0D1E812957595E7A0763DFA46953070863838812A9504F7A376078FEA9444B27E15FC043AE2D375D37DB1C6C3
  , 0xB31C13C287692760C2710CC4812A4CD3535248839E0B5220185BE58BBCE6A70D629E0749D40D9E79F698FFAFF7B9C53006419AAAD9AC1FAC2286F66DEC96AEB3
  , 0xAB020EA09B2573D7106EAA1D177F2E4A1F8E2237AD1481F9923DDF973A79CFC21A0B8CDDD22D3D78C488D0CC9BE8FAA8C74F0F2CFE619B7D7EA5B2E697E23372
  , 0x0D67BC1CFE545A6AE2F51A7FB2F32FC62E08707F9CBF2E08245E4594E9DB2A7ECBB6AB7190831C3D7D8F9D606231668E447C4EA29D69B4344952A97A77CC71CB
  , 0xE308FAEC064EC30CA1BEA7C2A02E95F4ABCBF7D7762557BE9872726F9020162F9B4EA11F621426EED6297C947BB3FAC269A8D0F38672EFBD72FDCCBEB8475221 ]

property set2_passes_tests = xorVectors set2raw == [groupBy`{8} digest | digest <- set2xorDigests]

set3xorDigests =
  [ 0xF3BCF4D6381742839C5627050D4B227FEB1ECCC527BF605C4CB9D6FB0618F419B51846707550BBEEE381E44A50A406D020C8433D08B19C98EFC867ED9897EDBB
  , 0xFDAEDE318DDD9EE44670318D51E812A2F9B6EAEB18B9EBDC0FB76D95CD0AE8C95792F6EA71332404798505D947B89B041D56FAD3B0D92BEC06428EC5A841EB82
  , 0xDE518E6B67BAEC2A516CCAB0475341C4BCC652ABE49ECCAA64E87248441A8F727BE173CACEBF8895B07DE8DDD28F1EE8AA739855F1E6DB70765AB1B55BC3B1ED
  , 0x697048C59621DBC7D47B6BE93A5060C4B2DFBDB1E7E444F1FC292C06C12974D126EA9C8FD09C63945E4D9107CD0A1AC57161CA8C7CFEF55CB60E52666C705EC6
  , 0x2FADEF81A5C4051CAC55E16C68CC6EEFCEE2D4966BAE782E3D885CAA2271EFBBE33F9313FD00632DC73441823713A48794C21E812E30A1DD4B2AE858A27E7C88
  , 0x8D1890B66A56552BE334B3472344F53DD2782D4ABB4514D0F5B761436C99740202A4B1244A1A7F485EFDB52C0065263FEE5A7D7DFC2BB754304CE9B2724119EB
  , 0xC2A8D317E3B1CB884A2C3B07F11FD38833282A9FBD1F6AF5C33CBE1E18D99B6499A241EA83A56605BC6B99259FBAAED4BDDA788B08CAAA93D2E00C6B5392ECF0
  , 0xF021DE2B24C80A48DE6F7F807F1EF2F813D72A77E7BFC12515F9F5755CEFF64CB5829CA780627A7920F3963E28005677B85A56017A6F5A403DA49F8F8B71581D
  , 0xAD0620EB4E71605CDEA447A02E638F0C2A0096EA666010761DB03CFC8562968044D213B15EC69E1E5811EEBE7C96B6166BE36E42B16F9F4BE0CC71B456C1FCA1
  , 0x119D1DDC7C95982B6B035FD4A4D8C5C9FD2518FFBC69C3C6A7F600174A3916146287F19BDDDAB385D2C6A39C593935F288B2F3E8895B9519EC71BA453319CC1F
  , 0x55AC113CC018689601F39AA80FA4FA26EE655D40F315C6B694FFAE74A09D382B62A4E7C60F75167361871A82561FFAC453BFED061D6B01672008308C92D241FF
  , 0x5BAFB9BEA29B3658A5BBF649E09455B70FB262AB938B65FE71652A0662FF0FB514C35AF438A72A6122AC1AA8591477AEAEB78214C63E41255E87230481D1A793
  , 0x6EE5BF7E194B03A7DDC92FC74A398FF822471FEF6DD399426F7372E445E1EE365ED7164CD09120A79CCF03D0A2A309DC5932441B64DDC6FDC9E183DA9F825106
  , 0x7ABF3C4E6E8CCAC05AA336DF2156E1957DFDAD45995FF6268B9708DAED9C2097F8F0F2A0EE5FBF4A7B511ED2E8E5617993E915E9BAABA30D758A9691E9D8578A
  , 0x9F569A8133067D1D4651BAE70DB3FE201649A1DA469C7D7C0B0DF16968285BF4ED0F36ED1CF9F213B2EC4BFF83D455FFC8B19E82DAE61408141F221C255DDFAB
  , 0x9B9EA936FD4385D3516304BEFC44BC6D5B60C97925B52CE269F2843496DEBD335A07ADA2EC87BA27E306CFFB884935D774EE317C7307740B884095278D1DB0C2
  , 0x0D4802AF0B0F92FFF2F80FE65FE5D1FBDFEF122231028FE36CC164D1D39185A1869AD43D08C6E1C9F8A9113CE2CEF0A022629C6FAC1C27E6DDF2A46C52293681
  , 0x9D6D8BAB5F6EDB5450EA2D5751741351199ED720B0572410FD698C99F2E0DB92C0E62E68AEE0CC6CDB6EA8898BFD29E8E106470DE4E5C66F94FE0258A2D24CA3
  , 0x12464226235C1DDDAFA37DF12F3A044442C0EEE521DBB7B3239C86ADB61AD6A0A418D3804252DC3658A3AE82473023A8D190E1EDB1DAFA3CF566573511CF8F19
  , 0x75BEFA10DACA457FFE4753A13543F9964CF17E6941318C931575A0865B1C86C12EE5E031EFD125A3D56C4B7846C19484507CC551C5CB558533E288BA0D2C14F1
  , 0x1E6FA2DF675C21D1AA9819BA05D3C96D3463D6F0758286BBB41A63F8748B94C8B652C60C5D4655E8436F2379CA7088B49625667F386BC5A2F25FD0BFB0088FAA
  , 0x9DBDBD0C3B340F294B1EB42CAD3111F0A5CF6A0B6206976022C6A2D6303A235B717542C25397879A27480D67AC5A245D0C58334CD801764A948060CA6F99E2D6
  , 0x3DD73F824FD1D9CB55B7E37C9C8A55C7EBB0866564AEA680BBBD431554D89E81FF280B563D5991438CEA5C183C607ADC23CC72CDE3A4D2CEB27B81ED8E5C9215
  , 0xA61CDBCF6F79213D2A789543B0EA3D8A22BA4FB8118C1D40AE56EC823886156620CED8AA76FFE917C1E52060F91EE73BC75E913D072C50B3D939E04F69493553
  , 0x9B29085D13B4992B077E3A878A5918B592C98C8A83956EC20EFE673A24C48C915D8DB1A4A66F62F1A3E7D6ADF6DC8845DD7A6D43F9DBF6C1EA21639060469AD6
  , 0x695757EDF4992CE9E1C088D62CAB18A38F56EE71F1F4866E88D1A02E07CB89B9133F0B02A23BA39622E84E19DACDF32397F29E50151F78524B717093131A10B1
  , 0xE0FE8129B73BCADA14FB385E6D3DB22D84C9755D63E93141202576FB5B2D3647D47B2F6378BC8567E4416976443FAE763C2B5FA46F2670C301A5B22802513D2D
  , 0xC6970385CA89CDFCACA9E90DA2A2FE9958EF83B9BF04DBE7A3B343750368883105FF6665D9F91D4DBBBCAF31B555ED3DD07C3AC824281730BF834693C596AD54
  , 0xD51B519D78CDBC8DF5CB1CEA5EBBA6E46530535D84CBF1696EBF238D3F7AA4A1D2F1EF5FF092DB57943E28501C64CFF04619197ED4A3D82EEEB2B2E9648D7494 ]

Set3Keys =
  [ 0x000102030405060708090A0B0C0D0E0F
  , 0x090A0B0C0D0E0F101112131415161718
  , 0x12131415161718191A1B1C1D1E1F2021
  , 0x1B1C1D1E1F202122232425262728292A
  , 0x2425262728292A2B2C2D2E2F30313233
  , 0x2D2E2F303132333435363738393A3B3C
  , 0x363738393A3B3C3D3E3F404142434445
  , 0x3F404142434445464748494A4B4C4D4E
  , 0x48494A4B4C4D4E4F5051525354555657
  , 0x5152535455565758595A5B5C5D5E5F60
  , 0x5A5B5C5D5E5F60616263646566676869
  , 0x636465666768696A6B6C6D6E6F707172
  , 0x6C6D6E6F707172737475767778797A7B
  , 0x75767778797A7B7C7D7E7F8081828384
  , 0x7E7F808182838485868788898A8B8C8D
  , 0x8788898A8B8C8D8E8F90919293949596
  , 0x909192939495969798999A9B9C9D9E9F
  , 0x999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8
  , 0xA2A3A4A5A6A7A8A9AAABACADAEAFB0B1
  , 0xABACADAEAFB0B1B2B3B4B5B6B7B8B9BA
  , 0xB4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3
  , 0xBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCC
  , 0xC6C7C8C9CACBCCCDCECFD0D1D2D3D4D5
  , 0xCFD0D1D2D3D4D5D6D7D8D9DADBDCDDDE
  , 0xD8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7
  , 0xE1E2E3E4E5E6E7E8E9EAEBECEDEEEFF0
  , 0xEAEBECEDEEEFF0F1F2F3F4F5F6F7F8F9
  , 0xF3F4F5F6F7F8F9FAFBFCFDFEFF000102
  , 0xFCFDFEFF000102030405060708090A0B ]

s3keys = [ groupBy`{8} key | key <- Set3Keys]

set3raw = [ groupBy`{64} (Salsa20_encrypt (k, iv, m))
        | k <- s3keys
        | iv <- nonces
        | m <- messages
        ]

property set3_passes_tests = xorVectors set3raw == [groupBy`{8} digest | digest <- set3xorDigests]
